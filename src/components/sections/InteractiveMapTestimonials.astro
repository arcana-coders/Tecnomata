---
// src/components/sections/InteractiveMapTestimonials.astro
import SectionHeader from '../ui/SectionHeader.astro';
import TestimonialCard from '../ui/TestimonialCard.astro';

// Datos de testimonios con coordenadas de Morelos
const mapTestimonials = [
  {
    author: "Mar칤a Gonz치lez",
    company: "",
    location: "Cuernavaca, Morelos",
    avatar: "MG",
    content: "En 3 meses pasamos de 0 a ser el primer resultado en Google Maps. Ahora recibimos m치s clientes que nunca.",
    color: "blue" as const,
    coordinates: { lat: 18.9261, lng: -99.2319 }, // Cuernavaca
    address: "Centro de Cuernavaca"
  },
  {
    author: "Roberto Mart칤nez",
    company: "",
    location: "Temixco, Morelos",
    avatar: "RM",
    content: "El SEO local cambi칩 nuestro negocio. De 2 clientes por semana a 20. La inversi칩n se pag칩 sola en el primer mes.",
    color: "green" as const,
    coordinates: { lat: 18.8458, lng: -99.2353 }, // Temixco
    address: "Zona Centro Temixco"
  },
  {
    author: "Ana Soriano",
    company: "",
    location: "Jiutepec, Morelos",
    avatar: "AS",
    content: "Tecnomata nos posicion칩 #1 en Google Maps. Nuestras ventas aumentaron 300% en 4 meses.",
    color: "purple" as const,
    coordinates: { lat: 18.8814, lng: -99.1822 }, // Jiutepec
    address: "Centro de Jiutepec"
  },
  {
    author: "Carlos Medina",
    company: "",
    location: "Cuautla, Morelos",
    avatar: "CM",
    content: "Mi taller ahora aparece primero en todas las b칰squedas locales. Los clientes nos encuentran f치cilmente.",
    color: "orange" as const,
    coordinates: { lat: 18.8073, lng: -98.9545 }, // Cuautla
    address: "Centro de Cuautla"
  },
  {
    author: "Laura V치zquez",
    company: "",
    location: "Yautepec, Morelos",
    avatar: "LV",
    content: "Pasamos de ser invisibles a recibir 15 llamadas diarias. El ROI ha sido impresionante desde el primer mes.",
    color: "red" as const,
    coordinates: { lat: 18.8833, lng: -99.0667 }, // Yautepec
    address: "Centro de Yautepec"
  },
  {
    author: "Jos칠 Luis P칠rez",
    company: "",
    location: "Xochitepec, Morelos",
    avatar: "JP",
    content: "La estrategia de SEO local super칩 nuestras expectativas. Ahora tenemos lista de espera para entregas.",
    color: "yellow" as const,
    coordinates: { lat: 18.7956, lng: -99.2442 }, // Xochitepec
    address: "Centro de Xochitepec"
  }
];
---

<section class="py-24 bg-gray-50">
  <div class="max-w-7xl mx-auto px-6">
    
    <SectionHeader
      pill="Casos de 칄xito"
      title="Negocios reales con <span class='text-blue-600'>resultados reales</span> en Morelos"
      subtitle="Descubre c칩mo hemos transformado la presencia digital de negocios en diferentes municipios de Morelos."
      color="blue"
    />

    <!-- Contenedor del mapa interactivo -->
    <div class="relative">
      
      <!-- Mapa de Google -->
      <div id="interactive-map" class="w-full h-[600px] rounded-2xl overflow-hidden shadow-2xl relative">
        <!-- El mapa se cargar치 aqu칤 -->
      </div>

      <!-- Tarjeta de testimonio flotante -->
      <div id="floating-testimonial" class="absolute top-8 left-8 w-80 max-w-sm z-10 transform transition-all duration-1000 opacity-0 scale-95 pointer-events-none">
        <!-- El testimonio activo se mostrar치 aqu칤 -->
      </div>

      <!-- Indicador de ubicaci칩n actual -->
      <div id="location-indicator" class="absolute bottom-8 left-8 bg-white/90 backdrop-blur-sm rounded-full px-6 py-3 shadow-lg">
        <div class="flex items-center gap-3">
          <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
          <span id="current-location" class="text-sm font-semibold text-gray-800">Cargando...</span>
        </div>
      </div>

      <!-- Controles de navegaci칩n -->
      <div class="absolute bottom-8 right-8 flex gap-2">
        <button id="prev-location" class="bg-white/90 backdrop-blur-sm rounded-full p-3 shadow-lg hover:bg-white transition-colors">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <button id="next-location" class="bg-white/90 backdrop-blur-sm rounded-full p-3 shadow-lg hover:bg-white transition-colors">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

    </div>

    <!-- Plantillas de testimonios (ocultas, usadas por JavaScript) -->
    <div id="testimonial-templates" class="hidden">
      {mapTestimonials.map((testimonial, index) => (
        <div class="testimonial-template" data-index={index}>
          <TestimonialCard author={testimonial.author} company={testimonial.company} color={testimonial.color}>
            <div slot="avatar" class={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm ${
              testimonial.color === 'blue' ? 'bg-blue-600' :
              testimonial.color === 'green' ? 'bg-green-600' :
              testimonial.color === 'purple' ? 'bg-purple-600' :
              testimonial.color === 'orange' ? 'bg-orange-600' :
              testimonial.color === 'red' ? 'bg-red-600' :
              testimonial.color === 'yellow' ? 'bg-yellow-600' : 'bg-gray-600'
            }`}>
              {testimonial.avatar}
            </div>
            <span slot="default">
              {testimonial.content}
            </span>
            <div slot="location" class="text-xs opacity-70 mt-1">
              游늸 {testimonial.location}
            </div>
          </TestimonialCard>
        </div>
      ))}
    </div>

  </div>
</section>

<style>
  /* Estilos para el mapa interactivo */
  #interactive-map {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #floating-testimonial.active {
    opacity: 1;
    scale: 1;
    pointer-events: auto;
    animation: testimonial-entrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* Animaci칩n de entrada dram치tica para el testimonio */
  @keyframes testimonial-entrance {
    0% {
      opacity: 0;
      scale: 0.6;
      transform: translateY(30px) rotate(-5deg);
    }
    50% {
      scale: 1.1;
    }
    100% {
      opacity: 1;
      scale: 1;
      transform: translateY(0) rotate(0deg);
    }
  }

  /* Animaci칩n del indicador de ubicaci칩n */
  #location-indicator {
    transition: all 0.5s ease-in-out;
  }

  /* Animaci칩n mejorada para el pin */
  #location-pin {
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Estilos para los controles */
  button:hover {
    transform: scale(1.1);
  }

  button:active {
    transform: scale(0.95);
  }

  /* Animaci칩n suave para cambios de ubicaci칩n */
  .location-transition {
    transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Animaci칩n personalizada para el pin */
  .pin-bounce {
    animation: pin-bounce 2s infinite;
  }

  @keyframes pin-bounce {
    0%, 20%, 50%, 80%, 100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-10px);
    }
    60% {
      transform: translateY(-5px);
    }
  }
</style>

<script>
  class InteractiveMapTestimonials {
    currentIndex: number;
    testimonials: any[];
    interval: ReturnType<typeof setInterval> | null;
    
    constructor() {
      this.currentIndex = 0;
      this.interval = null;
      
      // Datos de testimonios con posiciones visuales
      this.testimonials = [
        {
          author: "Mar칤a Gonz치lez",
          company: "",
          location: "Cuernavaca, Morelos",
          avatar: "MG",
          content: "En 3 meses pasamos de 0 a ser el primer resultado en Google Maps. Ahora recibimos m치s clientes que nunca.",
          color: "blue",
          address: "Centro de Cuernavaca",
          pinPosition: { x: 45, y: 35 }
        },
        {
          author: "Roberto Mart칤nez",
          company: "", 
          location: "Temixco, Morelos",
          avatar: "RM",
          content: "El SEO local cambi칩 nuestro negocio. De 2 clientes por semana a 20. La inversi칩n se pag칩 sola en el primer mes.",
          color: "green",
          address: "Zona Centro Temixco",
          pinPosition: { x: 40, y: 60 }
        },
        {
          author: "Ana Soriano",
          company: "",
          location: "Jiutepec, Morelos", 
          avatar: "AS",
          content: "Tecnomata nos posicion칩 #1 en Google Maps. Nuestras ventas aumentaron 300% en 4 meses.",
          color: "purple",
          address: "Centro de Jiutepec",
          pinPosition: { x: 55, y: 45 }
        },
        {
          author: "Carlos Medina",
          company: "",
          location: "Cuautla, Morelos",
          avatar: "CM", 
          content: "Mi taller ahora aparece primero en todas las b칰squedas locales. Los clientes nos encuentran f치cilmente.",
          color: "orange",
          address: "Centro de Cuautla",
          pinPosition: { x: 75, y: 70 }
        },
        {
          author: "Laura V치zquez",
          company: "",
          location: "Yautepec, Morelos",
          avatar: "LV",
          content: "Pasamos de ser invisibles a recibir 15 llamadas diarias. El ROI ha sido impresionante desde el primer mes.",
          color: "red", 
          address: "Centro de Yautepec",
          pinPosition: { x: 65, y: 40 }
        },
        {
          author: "Jos칠 Luis P칠rez", 
          company: "",
          location: "Xochitepec, Morelos",
          avatar: "JP",
          content: "La estrategia de SEO local super칩 nuestras expectativas. Ahora tenemos lista de espera para entregas.",
          color: "yellow",
          address: "Centro de Xochitepec",
          pinPosition: { x: 35, y: 80 }
        }
      ];
      
      this.init();
    }

    async init() {
      this.initMap();
      this.setupEventListeners();
      this.startAutoRotation();
    }

    initMap() {
      const mapElement = document.getElementById('interactive-map');
      if (!mapElement) return;

      // Crear una representaci칩n visual del mapa con CSS
      this.createVisualMap(mapElement);

      // Mostrar primer testimonio
      this.updateTestimonial(0);
    }

    createVisualMap(container: HTMLElement) {
      container.innerHTML = `
        <div class="relative w-full h-full bg-gradient-to-br from-green-400 via-blue-500 to-purple-600">
          <!-- Mapa base simulado -->
          <div class="absolute inset-0 opacity-20">
            <svg viewBox="0 0 800 600" class="w-full h-full">
              <!-- R칤os y carreteras simulados -->
              <path d="M100 200 Q200 180 300 200 T500 220 Q600 240 700 200" stroke="rgba(255,255,255,0.3)" stroke-width="3" fill="none"/>
              <path d="M150 400 Q250 380 350 400 T550 420" stroke="rgba(255,255,255,0.2)" stroke-width="2" fill="none"/>
              <!-- Areas verdes simuladas -->
              <circle cx="200" cy="150" r="40" fill="rgba(34,197,94,0.3)"/>
              <circle cx="500" cy="300" r="60" fill="rgba(34,197,94,0.2)"/>
              <circle cx="650" cy="450" r="35" fill="rgba(34,197,94,0.3)"/>
            </svg>
          </div>
          
          <!-- Pin de ubicaci칩n animado -->
          <div id="location-pin" class="absolute transform -translate-x-1/2 -translate-y-full transition-all duration-1000 ease-out">
            <div class="relative">
              <!-- Sombra del pin -->
              <div class="absolute top-8 left-1/2 transform -translate-x-1/2 w-4 h-2 bg-black/20 rounded-full blur-sm"></div>
              <!-- Pin principal -->
              <div class="w-8 h-8 bg-red-500 rounded-full border-4 border-white shadow-lg relative pin-bounce">
                <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-8 border-l-transparent border-r-transparent border-t-red-500"></div>
              </div>
              <!-- Pulso de ubicaci칩n -->
              <div class="absolute inset-0 w-8 h-8 bg-red-500 rounded-full animate-ping opacity-20"></div>
            </div>
          </div>

          <!-- Etiqueta de ubicaci칩n -->
          <div id="location-label" class="absolute bg-white/90 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg text-sm font-semibold text-gray-800 transition-all duration-1000 opacity-0">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 bg-red-500 rounded-full"></div>
              <span id="pin-location">Cuernavaca, Morelos</span>
            </div>
          </div>
        </div>
      `;
    }

    positionPin(index: number) {
      const testimonial = this.testimonials[index];
      if (!testimonial) return;

      const pin = document.getElementById('location-pin');
      const label = document.getElementById('location-label');
      const pinLocation = document.getElementById('pin-location');

      if (!pin || !label || !pinLocation) return;

      // Actualizar posici칩n del pin
      pin.style.left = `${testimonial.pinPosition.x}%`;
      pin.style.top = `${testimonial.pinPosition.y}%`;

      // Actualizar etiqueta
      pinLocation.textContent = testimonial.address;
      
      // Posicionar etiqueta cerca del pin pero sin solaparse
      label.style.left = `${Math.min(testimonial.pinPosition.x + 5, 75)}%`;
      label.style.top = `${Math.max(testimonial.pinPosition.y - 8, 5)}%`;

      // Mostrar etiqueta despu칠s de un breve retraso
      setTimeout(() => {
        label.style.opacity = '1';
      }, 500);
    }

    updateTestimonial(index: number) {
      const testimonial = this.testimonials[index];
      if (!testimonial) return;

      // PASO 1: Ocultar tarjeta actual inmediatamente
      const floatingContainer = document.getElementById('floating-testimonial');
      if (floatingContainer) {
        floatingContainer.classList.remove('active');
      }

      // PASO 2: Ocultar etiqueta y pin actuales
      const label = document.getElementById('location-label');
      const pin = document.getElementById('location-pin');
      if (label) label.style.opacity = '0';
      if (pin) pin.style.opacity = '0';

      // PASO 3: Mover el mapa/pin a nueva ubicaci칩n (500ms)
      setTimeout(() => {
        this.positionPin(index);
        
        // Actualizar indicador de ubicaci칩n
        const locationIndicator = document.getElementById('current-location');
        if (locationIndicator) {
          locationIndicator.textContent = testimonial.address;
        }
        
        // Mostrar pin con animaci칩n
        if (pin) pin.style.opacity = '1';
      }, 500);

      // PASO 4: Mostrar tarjeta despu칠s de que aparezca el pin (1200ms total)
      setTimeout(() => {
        this.updateFloatingTestimonial(index);
      }, 1200);
    }

    updateFloatingTestimonial(index: number) {
      const floatingContainer = document.getElementById('floating-testimonial');
      const template = document.querySelector(`.testimonial-template[data-index="${index}"]`);
      
      if (!floatingContainer || !template) return;

      // Copiar contenido de la plantilla inmediatamente
      floatingContainer.innerHTML = (template as HTMLElement).innerHTML;
      
      // Mostrar nuevo testimonio con animaci칩n dram치tica
      setTimeout(() => {
        floatingContainer.classList.add('active');
      }, 100);
    }

    setupEventListeners() {
      const nextBtn = document.getElementById('next-location');
      const prevBtn = document.getElementById('prev-location');

      nextBtn?.addEventListener('click', () => {
        this.next();
      });

      prevBtn?.addEventListener('click', () => {
        this.previous();
      });
    }

    next() {
      // Pausar auto-rotaci칩n temporalmente cuando se navega manualmente
      if (this.interval) {
        clearInterval(this.interval);
        this.startAutoRotation();
      }
      
      this.currentIndex = (this.currentIndex + 1) % this.testimonials.length;
      this.updateTestimonial(this.currentIndex);
    }

    previous() {
      // Pausar auto-rotaci칩n temporalmente cuando se navega manualmente
      if (this.interval) {
        clearInterval(this.interval);
        this.startAutoRotation();
      }
      
      this.currentIndex = (this.currentIndex - 1 + this.testimonials.length) % this.testimonials.length;
      this.updateTestimonial(this.currentIndex);
    }

    startAutoRotation() {
      this.interval = setInterval(() => {
        this.next();
      }, 6000); // Cambiar cada 6 segundos (tiempo optimizado para la nueva secuencia)
    }

    stopAutoRotation() {
      if (this.interval) {
        clearInterval(this.interval);
        this.interval = null;
      }
    }
  }

  // Inicializar cuando el DOM est칠 listo
  document.addEventListener('DOMContentLoaded', () => {
    new InteractiveMapTestimonials();
  });
</script>