---
// src/components/sections/Testimonials.astro
import SectionHeader from '../ui/SectionHeader.astro';
import TestimonialCard from '../ui/TestimonialCard.astro';
import MaterialSymbol from '../ui/MaterialSymbol.astro'; // Added import
---

<section class="py-24 bg-white scroll-animate" data-animate="scale-in" data-delay="200">
  <div class="max-w-7xl mx-auto px-6">
    
    <SectionHeader
      pill="Testimonios"
      title="Lo que dicen nuestros<br/><span class='text-blue-600'>clientes satisfechos</span>"
      subtitle="Resultados reales de negocios de Morelos que han transformado su presencia digital con Tecnomata."
      color="blue"
    />

  <!-- Contenedor del carrusel con tarjeta principal destacada -->
    <div class="testimonials-featured-carousel relative">
      <div class="testimonial-track flex items-center justify-center gap-4 md:gap-6 lg:gap-8">
        
        <div class="testimonial-item" data-index="0">
          <TestimonialCard author="Dr. Miguel Hern谩ndez" company="" color="yellow">
            <div slot="avatar" class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-sm">MH</div>
            <Fragment slot="default">
              Antes no aparec铆amos ni en la p谩gina 5 de Google. Ahora somos el primer resultado cuando buscan 'dentista en Cuernavaca'. Las citas se triplicaron en 3 meses.
            </Fragment>
            <div slot="location" class="text-xs opacity-70 mt-1">
               Cuernavaca, Morelos
            </div>
          </TestimonialCard>
        </div>

        <div class="testimonial-item" data-index="1">
          <TestimonialCard author="Ana L贸pez" company="" color="green">
            <div slot="avatar" class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-sm">AL</div>
            <Fragment slot="default">
              El SEO local cambi贸 nuestro negocio. De 2 clientes por semana a 20. La inversi贸n se pag贸 sola en el primer mes.
            </Fragment>
            <div slot="location" class="text-xs opacity-70 mt-1">
               Jiutepec, Morelos
            </div>
          </TestimonialCard>
        </div>

        <div class="testimonial-item" data-index="2">
          <TestimonialCard author="Carlos Mendoza" company="" color="blue">
            <div slot="avatar" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm">CM</div>
            <Fragment slot="default">
              Tecnomata nos posicion贸 #1 en Google Maps. Nuestras ventas aumentaron 400% en 6 meses. 隆Incre铆ble trabajo!
            </Fragment>
            <div slot="location" class="text-xs opacity-70 mt-1">
               Temixco, Morelos
            </div>
          </TestimonialCard>
        </div>

        <div class="testimonial-item" data-index="3">
          <TestimonialCard author="Mar铆a Rodr铆guez" company="" color="pink">
            <div slot="avatar" class="w-8 h-8 bg-pink-600 rounded-full flex items-center justify-center text-white font-bold text-sm">MR</div>
            <Fragment slot="default">
              Pasamos de ser invisibles a recibir 15 llamadas diarias. El ROI ha sido impresionante desde el primer mes.
            </Fragment>
            <div slot="location" class="text-xs opacity-70 mt-1">
               Yautepec, Morelos
            </div>
          </TestimonialCard>
        </div>

        <div class="testimonial-item" data-index="4">
          <TestimonialCard author="Roberto Silva" company="" color="orange">
            <div slot="avatar" class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center text-white font-bold text-sm">RS</div>
            <Fragment slot="default">
              Mi taller mec谩nico ahora aparece primero en todas las b煤squedas locales. Los clientes nos encuentran f谩cilmente.
            </Fragment>
            <div slot="location" class="text-xs opacity-70 mt-1">
               Cuautla, Morelos
            </div>
          </TestimonialCard>
        </div>

        <div class="testimonial-item" data-index="5">
          <TestimonialCard author="Lucia Morales" company="" color="purple">
            <div slot="avatar" class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm">LM</div>
            <Fragment slot="default">
              La estrategia de SEO local super贸 todas nuestras expectativas. Ahora tenemos lista de espera para citas.
            </Fragment>
            <div slot="location" class="text-xs opacity-70 mt-1">
               Xochitepec, Morelos
            </div>
          </TestimonialCard>
        </div>

      </div>
    </div>
  </div>
</section>

<style>
  .testimonials-featured-carousel {
    position: relative;
    width: 100%;
    height: 500px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    perspective: 1200px;
  }

  .testimonial-track {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
  }

  .testimonial-item {
    position: absolute;
    left: 50%;
    top: 50%;
    transform-origin: center center;
    transition: all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    backface-visibility: hidden;
    margin: 0;
    padding: 0;
  }

  /* Tama帽os para iPad Pro y Desktop grandes - POST-ITS VERTICALES */
  @media (min-width: 1024px) {
    .testimonials-featured-carousel {
      height: 600px;
    }
    
    .testimonial-item {
      width: 280px;
      max-width: 280px;
      height: 380px;
    }
  }

  /* Tama帽os para iPad y tablets - POST-ITS VERTICALES */
  @media (min-width: 768px) and (max-width: 1023px) {
    .testimonials-featured-carousel {
      height: 550px;
    }
    
    .testimonial-item {
      width: 260px;
      max-width: 260px;
      height: 360px;
    }
  }

  /* Tama帽os para m贸viles grandes - POST-ITS VERTICALES (+15% m谩s grandes) */
  @media (min-width: 480px) and (max-width: 767px) {
    .testimonials-featured-carousel {
      height: 520px;
    }

    .testimonial-item {
      width: 275px;
      max-width: 275px;
      height: 390px;
    }
  }

  /* Tama帽os para m贸viles peque帽os - POST-ITS VERTICALES (+12% m谩s grandes) */
  @media (max-width: 479px) {
    .testimonials-featured-carousel {
      height: 480px;
    }

    .testimonial-item {
      width: 245px;
      max-width: 245px;
      height: 360px;
    }
  }

  /* Estados base del carrusel circular */
  .testimonial-item {
    opacity: 0.2;
    scale: 0.6;
    z-index: 1;
  }

  /* Posici贸n principal (frente del carrusel) - TODOS LOS TAMAOS */
  .testimonial-item[data-position="0"] {
    transform: translate(-50%, -50%) translateZ(0px);
    opacity: 1;
    z-index: 5;
  }

  /* Escalas espec铆ficas por tama帽o de pantalla para tarjeta principal */
  @media (min-width: 1024px) {
    .testimonial-item[data-position="0"] {
      scale: 1.3;
    }
  }

  @media (min-width: 768px) and (max-width: 1023px) {
    .testimonial-item[data-position="0"] {
      scale: 1.25;
    }
  }

  @media (max-width: 767px) {
    .testimonial-item[data-position="0"] {
      scale: 1.1;
    }
  }

  /* Posiciones laterales visibles SOLO en tablet y desktop - Ajustado para post-its verticales */
  @media (min-width: 768px) {
    /* Derecha cercana */
    .testimonial-item[data-position="1"] {
      transform: translate(-50%, -50%) translateX(280px) translateZ(-100px) rotateY(-25deg) scale(0.85);
      opacity: 0.6;
      z-index: 4;
    }

    /* Izquierda cercana */
    .testimonial-item[data-position="5"] {
      transform: translate(-50%, -50%) translateX(-280px) translateZ(-100px) rotateY(25deg) scale(0.85);
      opacity: 0.6;
      z-index: 4;
    }

    /* Derecha lejana */
    .testimonial-item[data-position="2"] {
      transform: translate(-50%, -50%) translateX(420px) translateZ(-200px) rotateY(-45deg) scale(0.7);
      opacity: 0.3;
      z-index: 2;
    }

    /* Izquierda lejana */
    .testimonial-item[data-position="4"] {
      transform: translate(-50%, -50%) translateX(-420px) translateZ(-200px) rotateY(45deg) scale(0.7);
      opacity: 0.3;
      z-index: 2;
    }

    /* Trasera (completamente oculta) */
    .testimonial-item[data-position="3"] {
      transform: translate(-50%, -50%) translateZ(-350px) rotateY(180deg) scale(0.5);
      opacity: 0;
      z-index: 1;
    }
  }

  /* En m贸viles SOLO mostrar la principal, perfectamente centrada */
  @media (max-width: 767px) {
    .testimonial-item:not([data-position="0"]) {
      transform: translate(-50%, -50%) scale(0.7);
      opacity: 0;
      z-index: 0;
      pointer-events: none;
    }
  }

  /* Asegurar centrado perfecto eliminando cualquier offset */
  .testimonials-featured-carousel * {
    box-sizing: border-box;
  }

  .testimonial-item[data-position="0"] {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  /* Animaci贸n suave del carrusel */
  @keyframes carousel-rotate {
    from {
      transform: rotateY(0deg);
    }
    to {
      transform: rotateY(360deg);
    }
  }

  /* Efecto de pausa en hover (desktop) */
  @media (min-width: 768px) {
    .testimonial-track:hover .testimonial-item {
      animation-play-state: paused;
    }
  }
</style>

<script>
  class CircularTestimonialsCarousel {
    currentRotation: number;
    testimonials: NodeListOf<Element>;
    totalTestimonials: number;
    interval: ReturnType<typeof setInterval> | null;
    isAnimating: boolean;

    constructor() {
      this.currentRotation = 0;
      this.testimonials = document.querySelectorAll('.testimonial-item');
      this.totalTestimonials = this.testimonials.length;
      this.interval = null;
      this.isAnimating = false;
      
      if (this.testimonials.length > 0) {
        this.init();
      }
    }

    init() {
      // Configurar posiciones iniciales del carrusel circular
      this.updateCarouselPositions();
      
      // Iniciar rotaci贸n autom谩tica
      this.startAutoRotation();
      
      // Pausar al hacer hover en desktop
      const carousel = document.querySelector('.testimonials-featured-carousel');
      if (carousel) {
        carousel.addEventListener('mouseenter', () => {
          if (window.innerWidth >= 768) {
            this.pauseAutoRotation();
          }
        });
        carousel.addEventListener('mouseleave', () => {
          if (window.innerWidth >= 768) {
            this.startAutoRotation();
          }
        });
      }
    }

    updateCarouselPositions() {
      this.testimonials.forEach((testimonial, index) => {
        // Calcular la posici贸n en el carrusel circular (0-5)
        const position = (index - this.currentRotation + this.totalTestimonials) % this.totalTestimonials;
        
        // Aplicar la posici贸n como atributo data
        (testimonial as HTMLElement).setAttribute('data-position', position.toString());
      });
    }

    rotateCarousel() {
      if (this.isAnimating) return;
      
      this.isAnimating = true;
      
      // Incrementar rotaci贸n (mover al siguiente elemento)
      this.currentRotation = (this.currentRotation + 1) % this.totalTestimonials;
      
      // Actualizar posiciones
      this.updateCarouselPositions();
      
      // Esperar a que termine la transici贸n antes de permitir la siguiente
      setTimeout(() => {
        this.isAnimating = false;
      }, 1500); // Duraci贸n de la transici贸n CSS (1.5s)
    }

    startAutoRotation() {
      this.pauseAutoRotation(); // Limpiar interval existente
      
      // Primera rotaci贸n despu茅s de tiempo inicial de lectura
      setTimeout(() => {
        this.rotateCarousel();
      }, 4000); // 4 segundos para leer la primera
      
      // Rotaci贸n constante cada 7 segundos - tiempo c贸modo para leer
      this.interval = setInterval(() => {
        this.rotateCarousel();
      }, 7000); // 7 segundos para leer cada testimonio c贸modamente
    }

    pauseAutoRotation() {
      if (this.interval) {
        clearInterval(this.interval);
        this.interval = null;
      }
    }

    // M茅todo para rotaci贸n manual (futuro uso)
    next() {
      this.rotateCarousel();
    }

    previous() {
      if (this.isAnimating) return;
      
      this.isAnimating = true;
      
      // Decrementar rotaci贸n (mover al elemento anterior)
      this.currentRotation = (this.currentRotation - 1 + this.totalTestimonials) % this.totalTestimonials;
      
      // Actualizar posiciones
      this.updateCarouselPositions();
      
      // Esperar a que termine la transici贸n
      setTimeout(() => {
        this.isAnimating = false;
      }, 1500);
    }
  }

  // Inicializar cuando el DOM est茅 listo
  document.addEventListener('DOMContentLoaded', () => {
    new CircularTestimonialsCarousel();
  });

  // Reinicializar en cambios de tama帽o de pantalla
  let resizeTimeout: ReturnType<typeof setTimeout>;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      const carousel = document.querySelector('.testimonials-featured-carousel');
      if (carousel) {
        new CircularTestimonialsCarousel();
      }
    }, 250);
  });
</script>